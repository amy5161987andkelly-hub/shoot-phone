<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<title>é˜²ç½å¤§äº‚é¬¥ V36.0ï¼šæ–°æ‰‹å¼•å°å¢å¼·ç‰ˆ</title>
<style>
    /* === 1. ä½ˆå±€è¨­å®š === */
    * { box-sizing: border-box; touch-action: none; user-select: none; -webkit-user-select: none; }
    body { 
        margin: 0; padding: 0; background: #000; 
        font-family: 'å¾®è»Ÿæ­£é»‘é«”', sans-serif; 
        height: 100vh; width: 100vw; overflow: hidden;
        display: flex; flex-direction: column;
    }

    /* ä¸ŠåŠéƒ¨ï¼šéŠæˆ²å€ */
    #game-wrapper {
        flex: 1; width: 100%; background: #222;
        display: flex; justify-content: center; align-items: flex-start;
        padding-top: 60px; position: relative; overflow: hidden;
    }
    canvas { box-shadow: 0 5px 20px #000; max-width: 100%; max-height: 100%; }

    /* UI è³‡è¨Šåˆ— */
    #ui-layer {
        position: absolute; top: 0; left: 0; width: 100%; height: 55px;
        display: flex; justify-content: space-between; align-items: center;
        padding: 0 15px; background: rgba(20,20,20,0.95); 
        pointer-events: none; z-index: 10; border-bottom: 2px solid #555;
    }
    .p-stat { width: 32%; display: flex; flex-direction: column; color: white; font-weight: bold; font-size: 14px; }
    .hp-bg { width: 100%; height: 6px; background: #444; border-radius: 3px; margin-top: 3px; }
    .hp-fill { height: 100%; transition: width 0.3s; }
    .center-hud { color: #ffd700; font-size: 20px; font-weight: bold; border: 2px solid #ffd700; padding: 2px 12px; border-radius: 12px; background: #000; }

    /* ä¸‹åŠéƒ¨ï¼šæ§åˆ¶å€ */
    #controls-area {
        height: 280px; min-height: 280px;
        width: 100%; background: #111; border-top: 2px solid #333;
        display: flex; align-items: center; justify-content: space-between;
        padding: 0 40px 50px 40px; z-index: 20;
    }

    /* æŒ‰éˆ•æ¨£å¼ */
    .dpad-container { position: relative; width: 160px; height: 160px; }
    .dbtn {
        position: absolute; width: 55px; height: 55px;
        background: #333; border: 2px solid #555; border-radius: 12px;
        color: #fff; display: flex; justify-content: center; align-items: center; font-size: 28px;
        box-shadow: 0 4px 0 #000;
    }
    .dbtn:active, .dbtn.active { background: #555; transform: translateY(4px); box-shadow: none; }
    #dp-u { top: 0; left: 52px; } #dp-d { bottom: 0; left: 52px; }
    #dp-l { top: 52px; left: 0; } #dp-r { top: 52px; right: 0; }

    .act-btn {
        width: 100px; height: 100px;
        background: #d33; border: 4px solid #f55; border-radius: 50%;
        color: white; font-weight: bold; font-size: 22px;
        display: flex; justify-content: center; align-items: center;
        box-shadow: 0 6px 0 #500;
    }
    .act-btn:active, .act-btn.active { transform: translateY(6px); box-shadow: none; background: #e44; }

    /* å½ˆçª— */
    .modal-overlay { 
        position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
        background: rgba(0,0,0,0.95); z-index: 100; 
        display: flex; flex-direction: column; align-items: center; justify-content: center; 
    }
    .panel { 
        background: #2a2a2a; border: 2px solid #ffd700; border-radius: 15px; 
        padding: 20px; width: 90%; max-width: 500px; text-align: center; color: white; 
        box-shadow: 0 0 30px rgba(0,0,0,0.8);
        max-height: 90vh; overflow-y: auto; /* é˜²æ­¢å…§å®¹å¤ªé•· */
    }
    .btn-green { 
        background: #28a745; color: white; border: none; padding: 12px 30px; 
        font-size: 20px; border-radius: 40px; margin-top: 15px; cursor: pointer; font-weight: bold; 
        box-shadow: 0 4px 0 #19692c; width: 80%;
    }
    .opt-btn { width: 100%; background: #444; border: 1px solid #666; color: white; padding: 15px; margin: 8px 0; border-radius: 8px; text-align: left; font-size: 18px; }
    .float-txt { position: absolute; font-weight: bold; font-size: 24px; animation: floatUp 0.8s forwards; text-shadow: 2px 2px 0 #000; z-index: 50; pointer-events: none; }
    @keyframes floatUp { to { transform: translateY(-50px); opacity: 0; } }

    /* æ–°æ‰‹å¼•å°æ¨£å¼ */
    .guide-box { background: #333; padding: 15px; border-radius: 10px; margin: 15px 0; text-align: left; font-size: 15px; line-height: 1.6; color: #ddd; border: 1px solid #555; }
    .item-row { display: flex; align-items: center; margin: 8px 0; }
    .icon-demo { width: 30px; height: 30px; display: inline-flex; justify-content: center; align-items: center; border-radius: 5px; margin-right: 10px; font-weight: bold; font-size: 18px; }
    .icon-gun { background: #aaa; color: #000; }
    .icon-hand { background: #93f; color: #fff; }
    .icon-plus { background: #0f0; color: #000; }
    .highlight { color: #ffd700; font-weight: bold; }
</style>
<script src="https://cdn.jsdelivr.net/npm/phaser@3.60.0/dist/phaser.min.js"></script>
</head>
<body>

<div id="game-wrapper">
    <div id="ui-layer">
        <div class="p-stat" style="color:#ff9999;">
            <div>ğŸ¦Š P1 <span id="p1-s">0</span> <span id="p1-i"></span></div>
            <div class="hp-bg"><div id="p1-hp" class="hp-fill" style="background:#ff4d4d; width:0%"></div></div>
        </div>
        <div class="center-hud" id="key-count">15</div>
        <div class="p-stat" style="color:#99ccff; text-align:right;">
            <div><span id="p2-i"></span> <span id="p2-s">0</span> ğŸ»</div>
            <div class="hp-bg"><div id="p2-hp" class="hp-fill" style="background:#4d94ff; width:0%; float:right;"></div></div>
        </div>
    </div>
</div>

<div id="controls-area">
    <div class="dpad-container">
        <div class="dbtn" id="dp-u">â–²</div><div class="dbtn" id="dp-d">â–¼</div>
        <div class="dbtn" id="dp-l">â—€</div><div class="dbtn" id="dp-r">â–¶</div>
    </div>
    <div class="act-btn" id="btn-act">USE</div>
</div>

<div id="modal-start" class="modal-overlay" style="z-index:200;">
    <div class="panel">
        <h1 style="color:#ffd700; margin:0 0 10px 0; font-size: 28px;">ğŸ›¡ï¸ é˜²ç½å¤§äº‚é¬¥</h1>
        <p style="color:#aaa; font-size:14px; margin-bottom:15px;">V36.0 æ–°æ‰‹æ•™å­¸ç‰ˆ</p>
        
        <div class="guide-box">
            <div style="border-bottom:1px solid #555; padding-bottom:10px; margin-bottom:10px;">
                <strong>ğŸ® éŠæˆ²ç›®æ¨™ï¼š</strong><br>
                æ“æ§ <span style="color:#ff6633">ğŸ¦Š P1</span> æ¶å¥ªå ´ä¸Šçš„ <span class="highlight">15 æŠŠé‘°åŒ™</span>ã€‚<br>
                ç¢°åˆ°é‘°åŒ™éœ€å›ç­”é˜²ç½å•é¡Œï¼Œç­”å°å¾—åˆ†ï¼
            </div>
            
            <strong>ğŸ“¦ é“å…·èªªæ˜ï¼š</strong> (ç­”é¡Œç²å¾—)
            <div class="item-row">
                <span class="icon-demo icon-gun">ğŸ”«</span> 
                <span><strong>è¨Šè™Ÿæ§ï¼š</strong>æ‰£å°æ‰‹ <span style="color:#f55">2 åˆ†</span> (éœ€é è¿‘)</span>
            </div>
            <div class="item-row">
                <span class="icon-demo icon-hand">âœ‹</span> 
                <span><strong>å·ç«Šæ‰‹ï¼š</strong>å·å°æ‰‹ <span style="color:#f55">2 åˆ†</span> çµ¦è‡ªå·±</span>
            </div>
            <div class="item-row">
                <span class="icon-demo icon-plus">âœš</span> 
                <span><strong>æ€¥æ•‘åŒ…ï¼š</strong>è‡ªå·±ç›´æ¥ <span style="color:#0f0">+3 åˆ†</span></span>
            </div>
            
            <div style="margin-top:10px; font-size:13px; color:#888;">
                âš ï¸ å°å¿ƒ AI ç†Šä¹Ÿæœƒæ¶åˆ†ï¼æŒ‰ <span style="color:#f55; border:1px solid #555; padding:0 4px; border-radius:4px;">USE</span> éµä½¿ç”¨é“å…·ã€‚
            </div>
        </div>

        <button class="btn-green" onclick="startGame()">ğŸ”Š é»æ“Šé–‹å•ŸéŸ³æ•ˆä¸¦é–‹å§‹</button>
    </div>
</div>

<div id="modal-quiz" class="modal-overlay" style="display:none;">
    <div class="panel">
        <div style="display:flex; justify-content:space-between; margin-bottom:15px; color:#ffd700; border-bottom:1px solid #555; padding-bottom:10px;">
            <span id="q-type" style="font-weight:bold; font-size:20px;">é¡Œç›®</span>
            <span id="q-timer" style="color:red; font-weight:bold; font-size:20px;">30</span>
        </div>
        <div id="q-text" style="text-align:left; margin-bottom:20px; font-weight:bold; font-size:20px; line-height:1.4;"></div>
        <div id="q-opts"></div>
    </div>
</div>

<div id="modal-end" class="modal-overlay" style="display:none;">
    <div class="panel">
        <div id="end-avatar" style="margin-bottom:15px;"></div>
        <h1 id="end-title" style="font-size:32px; margin:5px 0;"></h1>
        <h2 id="end-score" style="color:#ddd; font-size:24px; margin-top:5px;"></h2>
        <button class="btn-green" onclick="location.reload()">å†ç©ä¸€æ¬¡</button>
    </div>
</div>

<script>
    // --- 1. éŸ³æ•ˆ ---
    const Sfx = {
        ctx: null,
        init() { const AC = window.AudioContext||window.webkitAudioContext; this.ctx=new AC(); },
        play(t) {
            if(!this.ctx) return; if(this.ctx.state==='suspended') this.ctx.resume();
            const o=this.ctx.createOscillator(), g=this.ctx.createGain(), now=this.ctx.currentTime;
            o.connect(g); g.connect(this.ctx.destination);
            if(t==='ok'){ o.type='sine'; o.frequency.setValueAtTime(660,now); o.frequency.setValueAtTime(880,now+0.1); g.gain.linearRampToValueAtTime(0,now+0.3); o.start(); o.stop(now+0.3); }
            else if(t==='no'){ o.type='sawtooth'; o.frequency.setValueAtTime(150,now); g.gain.linearRampToValueAtTime(0,now+0.4); o.start(); o.stop(now+0.4); }
            else if(t==='get'){ o.type='triangle'; o.frequency.setValueAtTime(400,now); o.frequency.exponentialRampToValueAtTime(1000,now+0.1); g.gain.linearRampToValueAtTime(0,now+0.2); o.start(); o.stop(now+0.2); }
            else if(t==='shoot'){ o.type='square'; o.frequency.setValueAtTime(800,now); o.frequency.exponentialRampToValueAtTime(100,now+0.1); g.gain.linearRampToValueAtTime(0,now+0.1); o.start(); o.stop(now+0.1); }
            else if(t==='happy'){ 
                let notes = [523.25, 659.25, 783.99, 1046.50]; 
                notes.forEach((f,i)=>{ let o=this.ctx.createOscillator(); let g=this.ctx.createGain(); o.connect(g); g.connect(this.ctx.destination); o.type='sine'; o.frequency.value=f; g.gain.setValueAtTime(0.1,now+i*0.15); g.gain.exponentialRampToValueAtTime(0.01,now+i*0.15+0.3); o.start(now+i*0.15); o.stop(now+i*0.15+0.3); });
            }
            else if(t==='sad'){ 
                let notes = [440.00, 392.00, 349.23, 329.63]; 
                notes.forEach((f,i)=>{ let o=this.ctx.createOscillator(); let g=this.ctx.createGain(); o.connect(g); g.connect(this.ctx.destination); o.type='triangle'; o.frequency.value=f; g.gain.setValueAtTime(0.1,now+i*0.4); g.gain.linearRampToValueAtTime(0,now+i*0.4+0.6); o.start(now+i*0.4); o.stop(now+i*0.4+0.6); });
            }
        }
    };

    // --- 2. è®Šæ•¸ ---
    let gameActive = false, startTime = 0;
    let inputs = {u:false, d:false, l:false, r:false, a:false};
    let p1d = {s:0, hp:0, i:null}, p2d = {s:0, hp:0, i:null};
    let mainScene = null, qTimer = null;
    let mapGrid = []; 
    const COLS=20, ROWS=15, TILE=40;

    // --- 3. é¡Œåº« ---
    const MYTH_DB = [
        {id:1, text:"ç™¼ç¾ç“¦æ–¯å¤–æ´©æ™‚ï¼Œå¯ä»¥é–‹é›»é¢¨æ‰‡å¹æ•£å—ï¼Ÿ", ans:[{t:"å¯ä»¥ï¼ŒåŠ é€Ÿé€šé¢¨",c:false},{t:"ä¸è¡Œï¼Œç«èŠ±æœƒå¼•çˆ†",c:true}]},
        {id:2, text:"åœ°éœ‡æ™‚æ‡‰è©²èº²åœ¨ã€Œé»ƒé‡‘ä¸‰è§’ã€(å‚¢ä¿±æ—)å—ï¼Ÿ", ans:[{t:"æ˜¯ï¼Œé‚£æ˜¯ç”Ÿå­˜ç©ºé–“",c:false},{t:"å¦ï¼Œæ‡‰è¶´ä¸‹æ©è­·ç©©ä½",c:true}]},
        {id:3, text:"èº«ä¸Šè‘—ç«æ™‚ï¼Œæ‡‰è©²å¿«è·‘æ»…ç«å—ï¼Ÿ", ans:[{t:"å°ï¼Œåˆ©ç”¨é¢¨æ»…ç«",c:false},{t:"éŒ¯ï¼Œæ‡‰åœèººæ»¾",c:true}]},
        {id:4, text:"ç«ç½æ¿ƒç…™å¯†å¸ƒï¼Œé€ƒç”Ÿæ™‚æ‡‰è©²ï¼Ÿ", ans:[{t:"æ¡ä½å§¿å‹¢çˆ¬è¡Œ",c:true},{t:"æ‹¿æ¿•æ¯›å·¾æ‘€å£é¼»å¿«è·‘",c:false}]},
        {id:5, text:"è¢«æ¯’è›‡å’¬å‚·ï¼Œå¯ä»¥ç”¨å˜´å·´å¸å‡ºæ¯’æ¶²å—ï¼Ÿ", ans:[{t:"å¯ä»¥ï¼Œçˆ­å–æ™‚é–“",c:false},{t:"ä¸è¡Œï¼Œæœƒé€ æˆæ„ŸæŸ“",c:true}]},
        {id:6, text:"æ²¹é‹èµ·ç«ï¼Œå¯ä»¥ç›´æ¥ç”¨æ°´æ¾†ç†„å—ï¼Ÿ", ans:[{t:"å¯ä»¥",c:false},{t:"ä¸è¡Œï¼Œæœƒçˆ†ç‚¸",c:true}]},
        {id:7, text:"ç¡è¦ºæ™‚ç™¼ç”Ÿåœ°éœ‡ï¼Œæ‡‰è©²ç«‹åˆ»è¡å‡ºé–€ï¼Ÿ", ans:[{t:"å°ï¼Œé€ƒå‘½è¦ç·Š",c:false},{t:"éŒ¯ï¼Œç•™åœ¨åºŠä¸Šä¿è­·é ­éƒ¨",c:true}]},
        {id:8, text:"é­é‡æµ·å˜¯è­¦å ±ï¼Œæ‡‰è©²å¾€å“ªè£¡è·‘ï¼Ÿ", ans:[{t:"å¾€é«˜è™•é¿é›£",c:true},{t:"å»æµ·é‚Šçœ‹æµª",c:false}]},
        {id:9, text:"CPR çš„æŒ‰å£“é€Ÿç‡æ‡‰è©²æ˜¯ï¼Ÿ", ans:[{t:"æ¯åˆ†é˜60ä¸‹",c:false},{t:"æ¯åˆ†é˜100-120ä¸‹",c:true}]},
        {id:10, text:"é¢±é¢¨å¤©ç»ç’ƒè²¼è† å¸¶å¯ä»¥é˜²æ­¢ç»ç’ƒç ´ç¢å—ï¼Ÿ", ans:[{t:"å¯ä»¥å¢åŠ å¼·åº¦",c:false},{t:"ä¸èƒ½ï¼Œåªèƒ½æ¸›å°‘ç¢ç‰‡",c:true}]},
        {id:11, text:"é é˜²ä¸€æ°§åŒ–ç¢³ä¸­æ¯’ï¼Œæœ€é‡è¦çš„æ˜¯ï¼Ÿ", ans:[{t:"ä¿æŒé€šé¢¨",c:true},{t:"å¤šå™´èŠ³é¦™åŠ‘",c:false}]},
        {id:12, text:"ç«å ´é€ƒç”Ÿæ‘¸é–€æŠŠç™¼ç‡™ï¼Œæ‡‰è©²ï¼Ÿ", ans:[{t:"ç”¨åŠ›é–‹é–€",c:false},{t:"ä¸å¯é–‹é–€ï¼Œå°‹æ‰¾å…¶ä»–å‡ºå£",c:true}]},
        {id:13, text:"æººæ°´è€…æ•‘ä¸Šå²¸ç„¡å‘¼å¸ï¼Œæ‡‰å…ˆï¼Ÿ", ans:[{t:"å€’æ›æ§æ°´",c:false},{t:"é€²è¡Œ CPR",c:true}]},
        {id:14, text:"åœ°éœ‡æ™‚åœ¨é›»æ¢¯å…§ï¼Œæ‡‰è©²ï¼Ÿ", ans:[{t:"æŒ‰ä¸‹æ‰€æœ‰æ¨“å±¤ç›¡å¿«å‡ºå»",c:true},{t:"èº²åœ¨é›»æ¢¯è§’è½",c:false}]},
        {id:15, text:"æ ¸ç½ç™¼ç”Ÿæœç”¨ç¢˜ç‰‡çš„ä¸»è¦ç›®çš„æ˜¯ï¼Ÿ", ans:[{t:"æ²»ç™‚è¼»å°„ç¼å‚·",c:false},{t:"ä¿è­·ç”²ç‹€è…º",c:true}]},
        {id:16, text:"ç‡™å‚·æ€¥æ•‘ã€Œæ²–è„«æ³¡è“‹é€ã€ï¼Œè„«è¡£å‰è¦å…ˆï¼Ÿ", ans:[{t:"å¡—è—¥è†",c:false},{t:"åœ¨æ°´ä¸­å……åˆ†å†·å»",c:true}]},
        {id:17, text:"æ»…ç«å™¨å£è¨£ã€Œæ‹‰ç„å£“æƒã€ï¼Œç„æº–å“ªè£¡ï¼Ÿ", ans:[{t:"ç«ç„°é ‚ç«¯",c:false},{t:"ç«æºæ ¹éƒ¨",c:true}]},
        {id:18, text:"è½åˆ°åœŸçŸ³æµè­¦æˆ’ï¼Œæ‡‰è©²ï¼Ÿ", ans:[{t:"é…åˆç–æ•£",c:true},{t:"ç•™åœ¨å®¶è£¡çœ‹å®ˆ",c:false}]},
        {id:19, text:"çœ‹åˆ°æœ‰äººè§¸é›»ï¼Œå¯ä»¥ç›´æ¥ç”¨æ‰‹æ‹‰ä»–å—ï¼Ÿ", ans:[{t:"å¯ä»¥ï¼Œæ•‘äººç¬¬ä¸€",c:false},{t:"ä¸è¡Œï¼Œæœƒè·Ÿè‘—è§¸é›»",c:true}]},
        {id:20, text:"ç·Šæ€¥é¿é›£åŒ…æ‡‰è©²æº–å‚™å¹¾å¤©çš„ç³§é£Ÿï¼Ÿ", ans:[{t:"è‡³å°‘3å¤©",c:true},{t:"1é¤å°±å¤ ",c:false}]}
    ];

    function startGame() {
        Sfx.init(); if(Sfx.ctx) Sfx.ctx.resume();
        document.getElementById('modal-start').style.display = 'none';
        gameActive = true; startTime = Date.now();
        if(mainScene) mainScene.physics.resume();
    }

    // --- 4. æ§åˆ¶ ---
    const bindBtn = (id, k) => {
        let el = document.getElementById(id);
        const on = (e) => { e.preventDefault(); inputs[k] = true; el.style.background='#555'; };
        const off = (e) => { e.preventDefault(); inputs[k] = false; el.style.background='#333'; };
        el.addEventListener('touchstart', on, {passive:false}); el.addEventListener('touchend', off);
        el.addEventListener('mousedown', on); el.addEventListener('mouseup', off);
    };
    bindBtn('dp-u','u'); bindBtn('dp-d','d'); bindBtn('dp-l','l'); bindBtn('dp-r','r');
    
    const actBtn = document.getElementById('btn-act');
    actBtn.addEventListener('touchstart', (e)=>{ e.preventDefault(); inputs.a=true; actBtn.style.background='#e44'; }, {passive:false});
    actBtn.addEventListener('touchend', (e)=>{ e.preventDefault(); inputs.a=false; actBtn.style.background='#d33'; });
    actBtn.addEventListener('mousedown', ()=>{ inputs.a=true; actBtn.style.background='#e44'; });
    actBtn.addEventListener('mouseup', ()=>{ inputs.a=false; actBtn.style.background='#d33'; });

    window.addEventListener('keydown', e=>{ if(gameActive){ 
        if(e.key==='ArrowUp') inputs.u=true; if(e.key==='ArrowDown') inputs.d=true;
        if(e.key==='ArrowLeft') inputs.l=true; if(e.key==='ArrowRight') inputs.r=true;
        if(e.key===' ') inputs.a=true;
    }});
    window.addEventListener('keyup', e=>{
        if(e.key==='ArrowUp') inputs.u=false; if(e.key==='ArrowDown') inputs.d=false;
        if(e.key==='ArrowLeft') inputs.l=false; if(e.key==='ArrowRight') inputs.r=false;
        if(e.key===' ') inputs.a=false;
    });

    // --- 5. Phaser ---
    const config = {
        type: Phaser.AUTO,
        parent: 'game-wrapper',
        scale: { mode: Phaser.Scale.FIT, autoCenter: Phaser.Scale.CENTER_HORIZONTALLY, width: 800, height: 600 },
        backgroundColor: '#222',
        physics: { default: 'arcade', arcade: { debug: false } },
        scene: { create: create, update: update }
    };
    new Phaser.Game(config);

    let p1, p2, keysGr, itemsGr;
    let lastAct = 0;
    // AI ç‹€æ…‹ï¼šCHASE(è¿½), WAIT(ç­”é¡Œç­‰å¾…), UNSTUCK(è„«å›°)
    let ai = { timer: 0, stuckTime: 0, waitTime: 0, lastPos: {x:0,y:0}, state: 'CHASE' };

    function create() {
        mainScene = this;
        const g = this.make.graphics();
        // Texture Gen
        g.fillStyle(0x666666); g.fillRect(0,0,40,40); g.lineStyle(2,0x888888); g.strokeRect(0,0,40,40); g.generateTexture('wall',40,40);
        g.clear(); g.fillStyle(0xff6633); g.beginPath(); g.moveTo(2,8); g.lineTo(30,8); g.lineTo(16,30); g.fill(); g.fillStyle(0xffffff); g.fillCircle(10,18,5); g.fillCircle(22,18,5); g.generateTexture('p1',32,32);
        g.clear(); g.fillStyle(0x4d94ff); g.fillCircle(16,16,16); g.fillStyle(0xffffff); g.fillCircle(10,12,4); g.fillCircle(22,12,4); g.generateTexture('p2',32,32);
        g.clear(); g.lineStyle(2,0xffd700); g.strokeCircle(10,6,5); g.fillStyle(0xffd700); g.fillRect(9,11,2,8); g.generateTexture('key',20,20);
        g.clear(); g.fillStyle(0xaaaaaa); g.fillRect(2,4,16,8); g.fillRect(2,4,6,12); g.generateTexture('gun',20,20);
        g.clear(); g.fillStyle(0x00ff00); g.fillRect(8,2,4,16); g.fillRect(2,8,16,4); g.generateTexture('plus',20,20);

        // Map
        let walls = this.physics.add.staticGroup();
        for(let r=0; r<ROWS; r++) {
            let row=[];
            for(let c=0; c<COLS; c++) {
                if(r===0||r===ROWS-1||c===0||c===COLS-1||(r%3===0&&c%3===0)){
                    walls.create(c*40+20, r*40+20, 'wall'); row.push(1);
                } else row.push(0);
            }
            mapGrid.push(row);
        }

        // Actors
        p1 = this.physics.add.sprite(100,100,'p1').setCollideWorldBounds(true);
        p2 = this.physics.add.sprite(700,500,'p2').setCollideWorldBounds(true);
        p1.body.setCircle(12,4,4); p2.body.setCircle(12,4,4);
        this.physics.add.collider(p1,walls); this.physics.add.collider(p2,walls);
        this.physics.add.collider(p1,p2);

        // Items
        keysGr = this.physics.add.group(); itemsGr = this.physics.add.group();
        let shuffledDB = [...MYTH_DB];
        shuffledDB.sort(() => Math.random() - 0.5);

        const spawn = (gr,tex,type,q) => {
            let safe=false, x, y;
            while(!safe) {
                let c=Phaser.Math.Between(1,COLS-2), r=Phaser.Math.Between(1,ROWS-2);
                if(mapGrid[r][c]===1) continue;
                x=c*TILE+20; y=r*TILE+20;
                if(Phaser.Math.Distance.Between(x,y,100,100)>200) safe=true;
            }
            let o=gr.create(x,y,tex); o.type=type; o.q=q;
        };

        for(let i=0; i<15; i++) spawn(keysGr,'key','score', shuffledDB[i]);
        for(let i=0; i<6; i++) {
            let q = shuffledDB[(i+15) % shuffledDB.length];
            spawn(itemsGr, i%2===0?'gun':'plus', i%2===0?'gun':'plus', q);
        }

        this.physics.add.overlap(p1, keysGr, (p,t)=>handleHit(1,t));
        this.physics.add.overlap(p2, keysGr, (p,t)=>handleHit(2,t));
        this.physics.add.overlap(p1, itemsGr, (p,t)=>handleHit(1,t));
        this.physics.add.overlap(p2, itemsGr, (p,t)=>handleHit(2,t));

        this.physics.pause();
    }

    function update(time, delta) {
        if(gameActive && keysGr.countActive() === 0) { endGame(); return; }

        if(!gameActive) { p1.setVelocity(0); p2.setVelocity(0); return; }

        const spd = 280;
        let vx=0, vy=0;
        if(inputs.l) vx=-spd; else if(inputs.r) vx=spd;
        if(inputs.u) vy=-spd; else if(inputs.d) vy=spd;
        p1.setVelocity(vx, vy);

        if(inputs.a && Date.now()-lastAct>500) { useItem(1); lastAct=Date.now(); }

        // AI Logic
        ai.timer += delta;
        if(ai.state === 'WAIT') {
            p2.setVelocity(0);
            ai.waitTime -= delta;
            if(ai.waitTime <= 0) ai.state = 'CHASE';
            return; 
        }

        if(ai.timer > 500) {
            let d = Phaser.Math.Distance.Between(p2.x, p2.y, ai.lastPos.x, ai.lastPos.y);
            if(d<5) { 
                ai.state='UNSTUCK'; ai.stuckTime=1000; 
                p2.setVelocity(Phaser.Math.Between(-200,200), Phaser.Math.Between(-200,200)); 
            } else if(ai.state !== 'UNSTUCK') {
                ai.state='CHASE';
            }
            ai.lastPos={x:p2.x, y:p2.y}; ai.timer=0;
        }

        if(ai.state==='CHASE') {
            let targets=[...keysGr.getChildren(),...itemsGr.getChildren()].filter(t=>t.active);
            if(targets.length>0) { 
                let c=this.physics.closest(p2,targets); 
                if(c) this.physics.moveToObject(p2,c, 160); 
            } else {
                p2.setVelocity(0);
            }
            if(p2d.i && Phaser.Math.Distance.Between(p1.x,p1.y,p2.x,p2.y)<200) useItem(2);
        } else if(ai.state==='UNSTUCK') {
            ai.stuckTime-=delta; if(ai.stuckTime<=0) ai.state='CHASE';
        }
        
        document.getElementById('key-count').innerText = keysGr.countActive();
    }

    function handleHit(pid, target) {
        if(!gameActive || !target.active) return;
        if(Date.now()-startTime<3000) return;
        
        if(pid===1) { 
            gameActive=false; mainScene.physics.pause(); showQuiz(target); 
        } else { 
            target.disableBody(true,true); 
            ai.state = 'WAIT';
            ai.waitTime = 2000; 
            p2.setVelocity(0); 
            if(Math.random()>0.3) gainReward(2, target.type); 
        }
    }

    function showQuiz(target) {
        let q = target.q;
        document.getElementById('modal-quiz').style.display='flex';
        document.getElementById('q-type').innerText=target.type==='score'?"ğŸ”‘ æ¶é‘°åŒ™":"ğŸ æ¶é“å…·";
        document.getElementById('q-text').innerText=q.text;
        let div = document.getElementById('q-opts'); div.innerHTML='';
        q.ans.sort(()=>Math.random()-0.5).forEach(a=>{
            let btn=document.createElement('button'); btn.className='opt-btn'; btn.innerText=a.t;
            btn.onclick=()=>{
                if(a.c){ 
                    Sfx.play('ok'); 
                    target.destroy(); 
                    gainReward(1,target.type); 
                }
                else{ Sfx.play('no'); p1.setPosition(p1.x-30,p1.y-30); }
                closeQuiz();
            }; div.appendChild(btn);
        });
        let t=30; document.getElementById('q-timer').innerText=t;
        if(qTimer) clearInterval(qTimer);
        qTimer=setInterval(()=>{ t--; document.getElementById('q-timer').innerText=t; if(t<=0){ Sfx.play('no'); closeQuiz(); } },1000);
    }

    function closeQuiz() {
        document.getElementById('modal-quiz').style.display='none'; clearInterval(qTimer);
        gameActive=true; mainScene.physics.resume();
    }

    function gainReward(pid, type) {
        if(pid===1) Sfx.play('get');
        if(type==='score') {
            if(pid===1) p1d.s++; else p2d.s++;
            document.getElementById(`p${pid}-s`).innerText = pid===1?p1d.s:p2d.s;
            document.getElementById(`p${pid}-hp`).style.width = Math.min((pid===1?p1d.s:p2d.s)*5, 100)+'%';
            floatText(pid===1?p1:p2, "+1", pid===1?"gold":"skyblue");
        } else {
            let d=pid===1?p1d:p2d; d.i=type;
            document.getElementById(`p${pid}-i`).innerText = type==='gun'?'ğŸ”«':'â•';
            if(type==='plus'){ d.s+=3; floatText(pid===1?p1:p2,"+3","#0f0"); } else floatText(pid===1?p1:p2,"GET!","#fff");
        }
        
        if(keysGr.countActive()===0) endGame();
    }

    function useItem(pid) {
        let d=pid===1?p1d:p2d; if(!d.i || d.i==='plus') return;
        let me=pid===1?p1:p2, target=pid===1?p2:p1;
        if(Phaser.Math.Distance.Between(me.x,me.y,target.x,target.y)>250){ if(pid===1) floatText(me,"å¤ªé !","#aaa"); return; }
        Sfx.play('shoot');
        if(pid===1) p2d.s=Math.max(0,p2d.s-2); else p1d.s=Math.max(0,p1d.s-2);
        floatText(target,"-2","#f00"); d.i=null; document.getElementById(`p${pid}-i`).innerText='';
        document.getElementById('p1-s').innerText=p1d.s; document.getElementById('p2-s').innerText=p2d.s;
    }

    function floatText(sp, txt, col) {
        let el=document.createElement('div'); el.className='float-txt'; el.innerText=txt; el.style.color=col;
        let rect=document.getElementById('game-wrapper').getBoundingClientRect();
        let sx=rect.width/800, sy=rect.height/600;
        el.style.left=(sp.x*sx+rect.left)+'px'; el.style.top=(sp.y*sy+rect.top-40)+'px';
        document.body.appendChild(el); setTimeout(()=>el.remove(),800);
    }

    function endGame() {
        if(!gameActive) return; 
        gameActive = false; 
        mainScene.physics.pause(); 
        
        let win = p1d.s >= p2d.s;
        Sfx.play(win ? 'happy' : 'sad');

        let modal = document.getElementById('modal-end');
        let avatarBox = document.getElementById('end-avatar');
        
        if(win) {
            avatarBox.innerHTML = `
                <div style="width:100px; height:100px; background:#ff6633; margin:0 auto; position:relative; border-radius:20px; box-shadow:0 0 15px #ff6633;">
                    <div style="position:absolute; top:-20px; left:-5px; width:0; height:0; border-left:20px solid transparent; border-right:20px solid transparent; border-bottom:30px solid #ff6633;"></div>
                    <div style="position:absolute; top:-20px; right:-5px; width:0; height:0; border-left:20px solid transparent; border-right:20px solid transparent; border-bottom:30px solid #ff6633;"></div>
                    <div style="position:absolute; bottom:15px; left:15px; width:20px; height:20px; background:white; border-radius:50%"></div>
                    <div style="position:absolute; bottom:15px; right:15px; width:20px; height:20px; background:white; border-radius:50%"></div>
                    <div style="position:absolute; bottom:35px; left:40px; width:20px; height:10px; background:black; border-radius:10px"></div>
                </div>`;
            document.getElementById('end-title').innerText = "ğŸ† P1 å‹åˆ©!";
            document.getElementById('end-title').style.color = "#ff6633";
        } else {
            avatarBox.innerHTML = `
                <div style="width:100px; height:100px; background:#4d94ff; margin:0 auto; position:relative; border-radius:50%; box-shadow:0 0 15px #4d94ff;">
                    <div style="position:absolute; top:-10px; left:5px; width:35px; height:35px; background:#4d94ff; border-radius:50%;"></div>
                    <div style="position:absolute; top:-10px; right:5px; width:35px; height:35px; background:#4d94ff; border-radius:50%;"></div>
                    <div style="position:absolute; top:30px; left:20px; width:15px; height:15px; background:white; border-radius:50%"></div>
                    <div style="position:absolute; top:30px; right:20px; width:15px; height:15px; background:white; border-radius:50%"></div>
                    <div style="position:absolute; top:55px; left:35px; width:30px; height:20px; background:white; border-radius:10px"></div>
                </div>`;
            document.getElementById('end-title').innerText = "ğŸ’€ AI ç²å‹";
            document.getElementById('end-title').style.color = "#4d94ff";
        }
        document.getElementById('end-score').innerText = `åˆ†æ•¸: ${p1d.s} - ${p2d.s}`;
        modal.style.display = 'flex';
    }
</script>
</body>
</html>
